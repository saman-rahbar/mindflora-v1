<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindFlora - AI-Powered Therapy Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: #1d1d1f;
            text-align: center;
            font-size: 2.75rem;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }

        .header p {
            text-align: center;
            color: #86868b;
            font-size: 1.125rem;
            font-weight: 400;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 24px 0;
            flex-wrap: wrap;
            padding: 0 16px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.8);
            color: #1d1d1f;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .nav-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* User Profile Styles */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            text-align: right;
        }

        .user-info .username {
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .user-info .welcome {
            font-size: 0.875rem;
            color: #86868b;
        }

        .logout-btn {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 59, 48, 0.2);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .logout-btn:hover {
            background: rgba(255, 59, 48, 0.15);
            transform: translateY(-1px);
        }

        /* Message Styles */
        #messages {
            margin: 24px 0;
        }

        .message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            font-weight: 500;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: #34C759;
            border-color: rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
            border-color: rgba(255, 59, 48, 0.2);
        }

        .message.info {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border-color: rgba(0, 122, 255, 0.2);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .card h2 {
            color: #1d1d1f;
            margin-bottom: 24px;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.01em;
        }

        .card h2 i {
            font-size: 1.75rem;
            color: #007AFF;
        }

        /* Gamification Section */
        .gamification {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #1d1d1f;
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .stat-card h3 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #007AFF;
            letter-spacing: -0.02em;
        }

        .stat-card p {
            color: #86868b;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1d1d1f;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }

        .btn-secondary {
            background: rgba(142, 142, 147, 0.1);
            color: #8E8E93;
            border: 1px solid rgba(142, 142, 147, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(142, 142, 147, 0.15);
            color: #8E8E93;
        }

        /* Therapy Modalities */
        .modality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .modality-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            border-left: 4px solid #007AFF;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modality-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .modality-card h4 {
            color: #1d1d1f;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .modality-card p {
            color: #86868b;
            font-size: 0.875rem;
            line-height: 1.6;
        }

        /* Journal Entries */
        .journal-entry {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            border-left: 4px solid #34C759;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .journal-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .journal-entry h4 {
            color: #34C759;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .journal-entry .timestamp {
            color: #86868b;
            font-size: 0.75rem;
            margin-bottom: 12px;
            font-weight: 500;
        }

        /* Mood Tracker */
        .mood-tracker {
            display: flex;
            justify-content: space-between;
            margin: 24px 0;
            gap: 8px;
        }

        .mood-option {
            text-align: center;
            cursor: pointer;
            padding: 16px 12px;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.05);
            flex: 1;
        }

        .mood-option:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .mood-option.selected {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .mood-option .emoji {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .gamification {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav {
                flex-direction: column;
                align-items: center;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 16px;
            }

            .card {
                padding: 24px;
            }
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 48px;
            color: #86868b;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            color: #007AFF;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modern animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .section {
            animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Success/Error Messages */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Hidden sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-brain"></i> MindFlora</h1>
                    <p>AI-Powered Therapy Platform - Your Journey to Mental Wellness</p>
                </div>
                <div id="user-profile" style="display: none; background: rgba(255, 255, 255, 0.9); padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(0, 122, 255, 0.2); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);">
                    <div class="user-profile">
                        <div class="user-info">
                            <div id="user-info" class="username" style="font-size: 1.1rem; font-weight: 600; color: #1d1d1f;"></div>
                            <div id="welcome-message" class="welcome" style="color: #86868b; font-size: 0.875rem;">Welcome back!</div>
                        </div>
                        <button id="logout-btn" class="logout-btn" onclick="logout()" style="margin-left: 16px;">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
                <div id="guest-indicator" style="display: flex; align-items: center; gap: 12px; color: #86868b; font-size: 0.875rem;">
                    <i class="fas fa-user" style="margin-right: 8px;"></i>
                    Guest User
                    <button onclick="showLoginForm()" style="background: rgba(0, 122, 255, 0.1); color: #007AFF; border: 1px solid rgba(0, 122, 255, 0.2); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <button class="nav-btn" onclick="showSection('therapy')">
                <i class="fas fa-heart"></i> Therapy
            </button>
            <button class="nav-btn" onclick="showSection('journaling')">
                <i class="fas fa-book"></i> Journal
            </button>
            <button class="nav-btn" onclick="showSection('gamification')">
                <i class="fas fa-trophy"></i> Progress
            </button>
            <button class="nav-btn" onclick="showSection('analytics')">
                <i class="fas fa-chart-line"></i> Analytics
            </button>
            <button class="nav-btn" onclick="showSection('ai-chat')">
                <i class="fas fa-comments"></i> AI Chat
            </button>
            <button class="nav-btn" onclick="showSection('assignments')">
                <i class="fas fa-tasks"></i> Assignments
            </button>
            <button class="nav-btn" onclick="showSection('calendar')">
                <i class="fas fa-calendar"></i> Calendar
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="gamification">
                <div class="stat-card">
                    <h3 id="user-level">1</h3>
                    <p>Level</p>
                </div>
                <div class="stat-card">
                    <h3 id="user-xp">0</h3>
                    <p>XP Points</p>
                </div>
                <div class="stat-card">
                    <h3 id="user-streak">0</h3>
                    <p>Day Streak</p>
                </div>
                <div class="stat-card">
                    <h3 id="user-sessions">0</h3>
                    <p>Therapy Sessions</p>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2><i class="fas fa-tasks"></i> Daily Missions</h2>
                    <div id="daily-missions">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Loading daily missions...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Quick Mood Check</h2>
                    <div class="mood-tracker">
                        <div class="mood-option" onclick="selectMood(1)">
                            <div class="emoji">üò¢</div>
                            <div>1</div>
                        </div>
                        <div class="mood-option" onclick="selectMood(2)">
                            <div class="emoji">üòï</div>
                            <div>2</div>
                        </div>
                        <div class="mood-option" onclick="selectMood(3)">
                            <div class="emoji">üòê</div>
                            <div>3</div>
                        </div>
                        <div class="mood-option" onclick="selectMood(4)">
                            <div class="emoji">üôÇ</div>
                            <div>4</div>
                        </div>
                        <div class="mood-option" onclick="selectMood(5)">
                            <div class="emoji">üòä</div>
                            <div>5</div>
                        </div>
                    </div>
                    <button class="btn" onclick="trackMood()">Track Mood</button>
                </div>
            </div>
        </div>

        <!-- Therapy Section -->
        <div id="therapy" class="section">
            <div class="card">
                <h2><i class="fas fa-heart"></i> Start Therapy Session</h2>
                
                <!-- Smart Therapy Option -->
                <div style="background: rgba(52, 199, 89, 0.1); color: #1d1d1f; padding: 24px; border-radius: 16px; margin-bottom: 24px; border: 1px solid rgba(52, 199, 89, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                    <h3 style="color: #34C759; margin-bottom: 16px; font-weight: 600;"><i class="fas fa-magic"></i> üß† Smart Therapy (Recommended)</h3>
                    <p style="margin-bottom: 12px; color: #86868b;"><strong>Just tell us how you're feeling</strong> - our AI will automatically determine the best therapy approach for you.</p>
                    <p style="margin-bottom: 20px; color: #86868b;"><strong>No need to choose therapy type</strong> - we'll analyze your words and match you with the perfect approach.</p>
                    <button type="button" class="btn" style="background: #34C759; color: white; margin-top: 10px; border: none;" onclick="showSmartTherapy()">
                        <i class="fas fa-magic"></i> Start Smart Therapy
                    </button>
                </div>
                

                
                <!-- Smart Therapy Form (Hidden by default) -->
                <form id="smart-therapy-form" style="display: none;">
                    <div class="form-group">
                        <label for="smart-session-content">How are you feeling today? Share what's on your mind...</label>
                        <textarea id="smart-session-content" rows="6" placeholder="Just write naturally about how you're feeling, what's bothering you, or what you're going through. Our AI will understand and choose the best therapy approach for you..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="smart-mood-before">How would you rate your mood right now? (1-10)</label>
                        <input type="number" id="smart-mood-before" min="1" max="10" placeholder="Rate your current mood">
                    </div>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #28a745, #20c997);">
                        <i class="fas fa-magic"></i> Let AI Choose Best Therapy
                    </button>
                </form>
                

            </div>

            <div class="card">
                <h2><i class="fas fa-list"></i> Available Therapy Modalities</h2>
                <div class="modality-grid">
                    <div class="modality-card">
                        <h4>Cognitive Behavioral Therapy (CBT)</h4>
                        <p>Identify and challenge negative thought patterns to improve emotional well-being.</p>
                    </div>
                    <div class="modality-card">
                        <h4>Logotherapy</h4>
                        <p>Find meaning and purpose in life, especially during difficult times.</p>
                    </div>
                    <div class="modality-card">
                        <h4>Acceptance & Commitment Therapy (ACT)</h4>
                        <p>Accept difficult thoughts and feelings while committing to value-based actions.</p>
                    </div>
                    <div class="modality-card">
                        <h4>Dialectical Behavior Therapy (DBT)</h4>
                        <p>Learn emotional regulation and interpersonal effectiveness skills.</p>
                    </div>
                    <div class="modality-card">
                        <h4>Somotherapy</h4>
                        <p>Body-centered therapy for trauma recovery and somatic awareness.</p>
                    </div>
                    <div class="modality-card">
                        <h4>Positive Psychology</h4>
                        <p>Focus on strengths, gratitude, and building positive emotions.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Journaling Section -->
        <div id="journaling" class="section">
            <div class="main-content">
                <div class="card">
                    <h2><i class="fas fa-pen"></i> Write Journal Entry</h2>
                    <form id="journal-form">
                        <div class="form-group">
                            <label for="reflection-type">Reflection Type</label>
                            <select id="reflection-type">
                                <option value="freeform">Freeform</option>
                                <option value="gratitude">Gratitude</option>
                                <option value="challenge">Challenge</option>
                                <option value="growth">Growth</option>
                                <option value="mindfulness">Mindfulness</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="journal-content">Your thoughts...</label>
                            <textarea id="journal-content" rows="8" placeholder="Write about your day, feelings, or reflections..." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="journal-mood">Mood Rating (Optional)</label>
                            <input type="number" id="journal-mood" min="1" max="10" placeholder="How are you feeling?">
                        </div>
                        <button type="submit" class="btn">Save Entry</button>
                    </form>
                </div>

                <div class="card">
                    <h2><i class="fas fa-history"></i> Recent Entries</h2>
                    <div id="journal-entries">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Loading journal entries...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gamification Section -->
        <div id="gamification" class="section">
            <div class="gamification">
                <div class="stat-card">
                    <h3 id="achievements-count">0</h3>
                    <p>Achievements</p>
                </div>
                <div class="stat-card">
                    <h3 id="missions-completed">0</h3>
                    <p>Missions Completed</p>
                </div>
                <div class="stat-card">
                    <h3 id="longest-streak">0</h3>
                    <p>Longest Streak</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-words">0</h3>
                    <p>Words Written</p>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-medal"></i> Achievements</h2>
                <div id="achievements-list">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading achievements...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="section">
            <div class="main-content">
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> Progress Overview</h2>
                    <div id="progress-chart">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Loading progress data...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-brain"></i> Therapeutic Insights</h2>
                    <div id="insights">
                        <div class="loading">
                            <i class="fas fa-spinner"></i>
                            <p>Generating insights...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Chat Section -->
        <div id="ai-chat" class="section">
            <div class="main-content">
                <div id="ai-chat-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading AI therapist chat...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assignments Section -->
        <div id="assignments" class="section">
            <div class="main-content">
                <div id="assignments-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading assignments...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendar" class="section">
            <div class="main-content">
                <div id="calendar-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading calendar integration...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages"></div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let selectedMood = null;
        const API_BASE = 'http://localhost:8000';

        // Function definitions (moved to top to avoid reference errors)
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load section-specific data
            switch(sectionId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'journaling':
                    loadJournalEntries();
                    break;
                case 'gamification':
                    loadGamificationData();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'ai-chat':
                    loadAIChat();
                    break;
                case 'assignments':
                    loadAssignments();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
            }
        }

        async function trackMood() {
            if (!selectedMood) {
                showMessage('Please select a mood first', 'error');
                return;
            }

            try {
                console.log('Tracking mood:', selectedMood);
                const moodData = {
                    mood_rating: selectedMood,
                    timestamp: new Date().toISOString()
                };
                console.log('Mood data:', moodData);
                
                const response = await apiCall('/journaling/mood', {
                    method: 'POST',
                    body: JSON.stringify(moodData)
                });

                console.log('Mood tracking response:', response);
                
                if (response && response.message === 'Mood tracked successfully') {
                    showMessage('Mood tracked successfully!', 'success');
                    selectedMood = null;
                    // Reset mood selection
                    document.querySelectorAll('.mood-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                } else {
                    console.error('Mood tracking failed - response:', response);
                    showMessage('Failed to track mood: ' + (response?.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Mood tracking error:', error);
                showMessage('Error tracking mood: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Test API connection first
            testAPIConnection();
            
            // Update user profile display
            updateUserProfile();
            
            // Check if user is logged in
            const token = localStorage.getItem('access_token');
            if (!token) {
                showLoginForm();
            } else {
                loadDashboard();
            }
        });

        // Test API connection
        async function testAPIConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/platform-info`);
                if (response.ok) {
                    console.log('‚úÖ API connection successful');
                    showMessage('API connected successfully!', 'success');
                } else {
                    console.error('‚ùå API connection failed:', response.status);
                    showMessage('API connection failed. Please check if the server is running.', 'error');
                }
            } catch (error) {
                console.error('‚ùå API connection error:', error);
                showMessage('Cannot connect to API server. Please check if the backend is running.', 'error');
            }
        }

        // Test user profile function (for debugging)
        function testUserProfile() {
            console.log('üß™ Testing user profile...');
            const token = localStorage.getItem('access_token');
            console.log('Token exists:', !!token);
            
            const userProfile = document.getElementById('user-profile');
            const guestIndicator = document.getElementById('guest-indicator');
            const userInfo = document.getElementById('user-info');
            
            console.log('User profile element:', userProfile);
            console.log('Guest indicator element:', guestIndicator);
            console.log('User info element:', userInfo);
            
            if (userProfile) {
                console.log('User profile display:', userProfile.style.display);
            }
            
            updateUserProfile();
        }

        // Logout function
        function logout() {
            console.log('Logging out user...');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            localStorage.removeItem('user_display_name');
            
            // Update UI to show guest state
            updateUserProfile();
            
            // Show login form
            showLoginForm();
            
            // Show success message
            showMessage('Successfully logged out!', 'success');
        }

        // Helper function to get user display name
        function getUserDisplayName() {
            return localStorage.getItem('user_display_name') || 'User';
        }

        // Helper function to get user context for therapy sessions
        function getUserContext() {
            const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
            const displayName = getUserDisplayName();
            
            let context = `User: ${displayName}`;
            
            if (userData.age) {
                context += `\nAge: ${userData.age}`;
            }
            
            if (userData.education_level) {
                const educationMap = {
                    'high_school': 'High School',
                    'some_college': 'Some College',
                    'associates': "Associate's Degree",
                    'bachelors': "Bachelor's Degree",
                    'masters': "Master's Degree",
                    'doctorate': 'Doctorate',
                    'other': 'Other'
                };
                const education = educationMap[userData.education_level] || userData.education_level;
                context += `\nEducation: ${education}`;
            }
            
            if (userData.therapy_preference) {
                context += `\nTherapy Preference: ${userData.therapy_preference.toUpperCase()}`;
            }
            
            return context;
        }

        // Navigation function moved to top to avoid reference errors

        // API Functions
        async function apiCall(endpoint, options = {}) {
            const token = localStorage.getItem('access_token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            try {
                // Ensure endpoint starts with /api/v1/ if it doesn't already
                const fullEndpoint = endpoint.startsWith('/api/v1/') ? endpoint : `/api/v1${endpoint}`;
                console.log('Making API call to:', `${API_BASE}${fullEndpoint}`);
                const response = await fetch(`${API_BASE}${fullEndpoint}`, {
                    ...defaultOptions,
                    ...options
                });
                
                console.log('Response status:', response.status);
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.removeItem('access_token');
                    showLoginForm();
                    return null;
                }
                
                if (!response.ok) {
                    console.error('API error:', response.status, response.statusText);
                    console.error('Request URL:', `${API_BASE}${fullEndpoint}`);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    showMessage(`API Error: ${response.status} - ${response.statusText}`, 'error');
                    return null;
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showMessage('Error connecting to server', 'error');
                return null;
            }
        }



        // Dashboard functions
        async function loadDashboard() {
            // Load user progress
            const progress = await apiCall('/gamification/progress');
            if (progress) {
                document.getElementById('user-level').textContent = progress.level;
                document.getElementById('user-xp').textContent = progress.total_xp;
                document.getElementById('user-streak').textContent = progress.current_streak;
                document.getElementById('user-sessions').textContent = progress.missions_completed_today;
            }

            // Load daily missions
            const missions = await apiCall('/gamification/daily-missions');
            if (missions) {
                displayDailyMissions(missions.missions);
            }
        }

        function displayDailyMissions(missions) {
            const container = document.getElementById('daily-missions');
            if (missions.length === 0) {
                container.innerHTML = '<p>No missions available today.</p>';
                return;
            }

            container.innerHTML = missions.map(mission => `
                <div class="journal-entry ${mission.completed ? 'completed' : ''}">
                    <h4>${mission.title}</h4>
                    <p>${mission.description}</p>
                    <p><strong>XP Reward:</strong> ${mission.xp_reward}</p>
                    ${mission.completed ? 
                        '<span class="badge success">‚úì Completed</span>' : 
                        '<button class="btn btn-secondary" onclick="completeMission(\'' + mission.id + '\')">Complete</button>'
                    }
                </div>
            `).join('');
        }

        // Smart Therapy functions
        function showSmartTherapy() {
            document.getElementById('smart-therapy-form').style.display = 'block';
            document.getElementById('therapy-form').style.display = 'none';
            document.querySelector('.nav-btn[onclick="showSection(\'therapy\')"]').textContent = 'üß† Smart Therapy';
        }

        function showTraditionalTherapy() {
            document.getElementById('smart-therapy-form').style.display = 'none';
            document.getElementById('therapy-form').style.display = 'block';
            document.querySelector('.nav-btn[onclick="showSection(\'therapy\')"]').textContent = 'üíô Therapy';
        }

        // Smart Therapy form
        document.getElementById('smart-therapy-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check if user is logged in
            const token = localStorage.getItem('access_token');
            if (!token) {
                showMessage('Please log in to use smart therapy.', 'error');
                return;
            }
            
            const formData = {
                session_content: document.getElementById('smart-session-content').value,
                mood_before: parseInt(document.getElementById('smart-mood-before').value) || null,
                user_context: getUserContext() // Include user context for personalized therapy
            };

            // Show loading state
            const submitBtn = document.querySelector('#smart-therapy-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ü§ñ AI Analyzing Your Needs...';
            submitBtn.disabled = true;

            try {
                const response = await apiCall('/therapy/smart-session', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    console.log('Smart therapy response:', response);
                    // Display smart therapy results
                    displaySmartTherapyResults(response);
                    showMessage('Smart therapy session completed! +' + (response.xp_earned || 0) + ' XP', 'success');
                    document.getElementById('smart-therapy-form').reset();
                    loadDashboard(); // Refresh dashboard
                } else {
                    // Handle error case
                    showMessage('Smart therapy session failed. Please check if you are logged in and try again.', 'error');
                }
            } catch (error) {
                console.error('Smart therapy error:', error);
                showMessage('Smart therapy session failed: ' + error.message, 'error');
            }

            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });

        function displaySmartTherapyResults(response) {
            const routingAnalysis = response.routing_analysis;
            const aiResponse = response.ai_response;
            
            // Safely access nested properties with fallbacks
            const therapyInfo = routingAnalysis?.recommendation?.therapy_info || {};
            const personalizedMessage = routingAnalysis?.recommendation?.personalized_message || 'AI analysis complete';
            const primaryTherapy = routingAnalysis?.primary_therapy || 'Unknown';
            const secondaryTherapies = routingAnalysis?.secondary_therapies || [];
            const analysis = routingAnalysis?.analysis || {};
            const techniques = aiResponse?.intervention?.techniques || [];
            const homework = aiResponse?.intervention?.homework || {};
            const therapeuticResponse = aiResponse?.intervention?.response || 'Therapeutic response generated';
            
            // Create smart therapy results display
            const resultsHTML = `
                <div class="card" style="margin-top: 20px; border-left: 4px solid #28a745;">
                    <h2><i class="fas fa-magic"></i> üß† Smart Therapy Analysis</h2>
                    
                    <!-- AI Recommendation -->
                    <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                        <h3><i class="fas fa-lightbulb"></i> AI Recommendation</h3>
                        <p><strong>Recommended Therapy:</strong> ${therapyInfo.name || 'AI Selected Therapy'}</p>
                        <p><strong>Confidence:</strong> ${Math.round((routingAnalysis?.confidence || 0) * 100)}%</p>
                        <p><em>"${personalizedMessage}"</em></p>
                    </div>
                    
                    <!-- Therapy Analysis -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3><i class="fas fa-brain"></i> Content Analysis</h3>
                            <p><strong>Primary Therapy:</strong> ${primaryTherapy.toUpperCase()}</p>
                            <p><strong>Secondary Options:</strong> ${secondaryTherapies.length > 0 ? secondaryTherapies.join(', ').toUpperCase() : 'None'}</p>
                            <p><strong>Mood Rating:</strong> ${response.mood_before || 'Not provided'}/10</p>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-chart-pie"></i> Therapy Match Scores</h3>
                            ${Object.entries(analysis).map(([therapy, data]) => 
                                `<p><strong>${therapy.toUpperCase()}:</strong> ${Math.round((data.confidence || 0) * 100)}% (${data.score || 0} matches)</p>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <!-- AI Response -->
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-comments"></i> Therapeutic Response</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                            <p><em>"${therapeuticResponse}"</em></p>
                        </div>
                    </div>
                    
                    <!-- Techniques and Homework -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3><i class="fas fa-tools"></i> Suggested Techniques</h3>
                            <ul style="list-style: none; padding: 0;">
                                ${techniques.length > 0 ? techniques.map(tech => `<li>‚úÖ ${tech}</li>`).join('') : '<li>‚úÖ Personalized techniques recommended</li>'}
                            </ul>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-homework"></i> Homework Assignment</h3>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeaa7;">
                                <p><strong>${(homework.type || 'personalized_assignment').replace('_', ' ').toUpperCase()}</strong></p>
                                <p>${homework.description || 'Complete your personalized homework assignment'}</p>
                                <p><small>Duration: ${homework.duration || '1 week'}</small></p>
                                <div style="margin-top: 10px; padding: 8px; background: #d4edda; border-radius: 6px; border: 1px solid #c3e6cb;">
                                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                    <span style="color: #155724; font-size: 14px;">‚úì Assignment added to Assignments tab</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Session Summary -->
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                        <h3><i class="fas fa-check-circle"></i> Session Summary</h3>
                        <ul>
                            <li>‚úÖ AI analysis completed successfully</li>
                            <li>‚úÖ Therapy type identified: ${primaryTherapy.toUpperCase()}</li>
                            <li>‚úÖ Personalized response generated</li>
                            <li>‚úÖ Techniques and homework assigned</li>
                            <li>‚úÖ XP earned: ${response.xp_earned || 0} points</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Insert results after the smart therapy form
            const therapySection = document.getElementById('therapy');
            const formCard = therapySection.querySelector('.card');
            formCard.insertAdjacentHTML('afterend', resultsHTML);
            
            // Create assignment in background without switching tabs
            const homeworkDescription = homework.description || 'Complete your personalized homework assignment';
            console.log('Creating assignment from therapy homework:', homeworkDescription);
            
            // Create assignment silently in background
            startAssignmentFromTherapySilent(homeworkDescription);
        }

        // Silent assignment creation (doesn't switch tabs)
        async function startAssignmentFromTherapySilent(homeworkDescription) {
            console.log('Creating assignment silently with description:', homeworkDescription);
            
            // Validate input
            if (!homeworkDescription || homeworkDescription.trim() === '') {
                console.error('No homework description provided');
                return;
            }
            
            try {
                // Create a new assignment from the therapy homework
                const assignmentData = {
                    title: "Therapy Homework",
                    description: homeworkDescription,
                    category: "homework",
                    estimated_duration: 30,
                    deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    instructions: homeworkDescription,
                    materials: ["Journal", "Quiet space"],
                    progress_questions: [
                        "How did you feel about this assignment?",
                        "What insights did you gain?",
                        "How can you apply this learning?"
                    ]
                };

                console.log('Sending assignment data:', assignmentData);
                const response = await apiCall('/therapy/assignments', {
                    method: 'POST',
                    body: JSON.stringify(assignmentData)
                });

                console.log('Assignment creation response:', response);
                if (response && response.success) {
                    // Store the assignment locally for immediate use
                    const createdAssignment = response.data;
                    localStorage.setItem('currentAssignment', JSON.stringify(createdAssignment));
                    console.log('Assignment created successfully in background');
                } else {
                    // Try to create assignment locally if API fails
                    console.log('API failed, creating assignment locally');
                    const localAssignment = {
                        id: Date.now().toString(),
                        title: "Therapy Homework",
                        description: homeworkDescription,
                        category: "homework",
                        status: "active",
                        estimated_duration: 30,
                        deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        progress: 0,
                        instructions: homeworkDescription,
                        materials: ["Journal", "Quiet space"],
                        progress_questions: [
                            "How did you feel about this assignment?",
                            "What insights did you gain?",
                            "How can you apply this learning?"
                        ],
                        created_at: new Date().toISOString()
                    };
                    localStorage.setItem('currentAssignment', JSON.stringify(localAssignment));
                    console.log('Assignment created locally in background');
                }
            } catch (error) {
                console.error('Error creating assignment silently:', error);
                // Don't show error to user since this is background process
            }
        }

        // Traditional Therapy functions
        document.getElementById('therapy-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                therapy_type: document.getElementById('therapy-type').value,
                session_content: document.getElementById('session-content').value,
                mood_before: parseInt(document.getElementById('mood-before').value) || null,
                user_context: getUserContext() // Include user context for personalized therapy
            };

            // Show loading state
            const submitBtn = document.querySelector('#therapy-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'ü§ñ AI Agent Analyzing...';
            submitBtn.disabled = true;

            const response = await apiCall('/therapy/session', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response) {
                // Display AI analysis results
                displayTherapyResults(response);
                showMessage('Therapy session completed successfully! +' + response.xp_earned + ' XP', 'success');
                document.getElementById('therapy-form').reset();
                loadDashboard(); // Refresh dashboard
            }

            // Reset button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });

        async function startAssignmentFromTherapy(homeworkDescription) {
            console.log('Starting assignment from therapy with description:', homeworkDescription);
            
            // Validate input
            if (!homeworkDescription || homeworkDescription.trim() === '') {
                console.error('No homework description provided');
                showMessage('Error: No assignment description provided', 'error');
                return;
            }
            
            try {
                // Create a new assignment from the therapy homework
                const assignmentData = {
                    title: "Therapy Homework",
                    description: homeworkDescription,
                    category: "homework",
                    estimated_duration: 30,
                    deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                    instructions: homeworkDescription,
                    materials: ["Journal", "Quiet space"],
                    progress_questions: [
                        "How did you feel about this assignment?",
                        "What insights did you gain?",
                        "How can you apply this learning?"
                    ]
                };

                console.log('Sending assignment data:', assignmentData);
                const response = await apiCall('/therapy/assignments', {
                    method: 'POST',
                    body: JSON.stringify(assignmentData)
                });

                console.log('Assignment creation response:', response);
                if (response && response.success) {
                    showMessage('Assignment created! Navigate to Assignments tab to start.', 'success');
                    // Store the assignment locally for immediate use
                    const createdAssignment = response.data;
                    localStorage.setItem('currentAssignment', JSON.stringify(createdAssignment));
                    // Switch to assignments tab and force refresh
                    showSection('assignments');
                    // Force reload assignments after a short delay
                    setTimeout(() => {
                        if (window.interactiveAssignments) {
                            window.interactiveAssignments.refreshAssignments();
                        }
                    }, 500);
                } else {
                    // Try to create assignment locally if API fails
                    console.log('API failed, creating assignment locally');
                    const localAssignment = {
                        id: Date.now().toString(),
                        title: "Therapy Homework",
                        description: homeworkDescription,
                        category: "homework",
                        status: "active",
                        estimated_duration: 30,
                        deadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        progress: 0,
                        instructions: homeworkDescription,
                        materials: ["Journal", "Quiet space"],
                        progress_questions: [
                            "How did you feel about this assignment?",
                            "What insights did you gain?",
                            "How can you apply this learning?"
                        ],
                        created_at: new Date().toISOString()
                    };
                    localStorage.setItem('currentAssignment', JSON.stringify(localAssignment));
                    showMessage('Assignment created! Navigate to Assignments tab to start.', 'success');
                    // Switch to assignments tab and force refresh
                    showSection('assignments');
                    // Force reload assignments after a short delay
                    setTimeout(() => {
                        if (window.interactiveAssignments) {
                            window.interactiveAssignments.refreshAssignments();
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Full error object:', error);
                console.error('Error stack:', error.stack);
                showMessage('Error creating assignment: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        function displayTherapyResults(response) {
            const aiResponse = response.ai_response;
            
            // Create results display
            const resultsHTML = `
                <div class="card" style="margin-top: 20px; border-left: 4px solid #667eea;">
                    <h2><i class="fas fa-robot"></i> AI Agent Analysis</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h3><i class="fas fa-brain"></i> Cognitive Analysis</h3>
                            <p><strong>Distortions Found:</strong> ${aiResponse.analysis.distortions_found.join(', ') || 'None detected'}</p>
                            <p><strong>Thought Balance:</strong> ${aiResponse.analysis.thought_patterns.thought_balance}</p>
                            <p><strong>Negative Thoughts:</strong> ${aiResponse.analysis.thought_patterns.negative_thoughts}</p>
                            <p><strong>Positive Thoughts:</strong> ${aiResponse.analysis.thought_patterns.positive_thoughts}</p>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-heart"></i> Emotional Analysis</h3>
                            <p><strong>Primary Emotion:</strong> ${aiResponse.analysis.emotion_analysis.primary_emotion || 'Not detected'}</p>
                            <p><strong>Intensity:</strong> ${aiResponse.analysis.emotion_analysis.intensity || 'N/A'}/10</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3><i class="fas fa-comments"></i> Therapeutic Response</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                            <p><em>"${aiResponse.intervention.response}"</em></p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3><i class="fas fa-tools"></i> Suggested Techniques</h3>
                            <ul style="list-style: none; padding: 0;">
                                ${aiResponse.intervention.techniques.map(tech => `<li>‚úÖ ${tech}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h3><i class="fas fa-homework"></i> Homework Assignment</h3>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeaa7;">
                                <p><strong>${aiResponse.intervention.homework.type.replace('_', ' ').toUpperCase()}</strong></p>
                                <p>${aiResponse.intervention.homework.description}</p>
                                <p><small>Duration: ${aiResponse.intervention.homework.duration}</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert results after the therapy form
            const therapySection = document.getElementById('therapy');
            const formCard = therapySection.querySelector('.card');
            formCard.insertAdjacentHTML('afterend', resultsHTML);
        }

        // Journaling functions
        document.getElementById('journal-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                content: document.getElementById('journal-content').value,
                reflection_type: document.getElementById('reflection-type').value,
                mood_rating: parseInt(document.getElementById('journal-mood').value) || null
            };

            const response = await apiCall('/journaling/entry', {
                method: 'POST',
                body: JSON.stringify(formData)
            });

            if (response) {
                showMessage('Journal entry saved successfully!', 'success');
                document.getElementById('journal-form').reset();
                loadJournalEntries();
                loadDashboard(); // Refresh dashboard
            }
        });

        async function loadJournalEntries() {
            const entries = await apiCall('/journaling/entries?limit=5');
            if (entries) {
                displayJournalEntries(entries);
            }
        }

        function displayJournalEntries(entries) {
            const container = document.getElementById('journal-entries');
            if (entries.length === 0) {
                container.innerHTML = '<p>No journal entries yet. Start writing!</p>';
                return;
            }

            container.innerHTML = entries.map(entry => `
                <div class="journal-entry">
                    <h4>${entry.reflection_type.charAt(0).toUpperCase() + entry.reflection_type.slice(1)}</h4>
                    <div class="timestamp">${new Date(entry.timestamp).toLocaleDateString()}</div>
                    <p>${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</p>
                    ${entry.mood_rating ? `<p><strong>Mood:</strong> ${entry.mood_rating}/10</p>` : ''}
                </div>
            `).join('');
        }

        // Mood tracking
        function selectMood(rating) {
            selectedMood = rating;
            document.querySelectorAll('.mood-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // trackMood function moved to top to avoid reference errors

        // Gamification functions
        async function loadGamificationData() {
            const progress = await apiCall('/gamification/progress');
            const achievements = await apiCall('/gamification/achievements');
            
            if (progress) {
                document.getElementById('achievements-count').textContent = progress.achievements_unlocked;
                document.getElementById('missions-completed').textContent = progress.missions_completed_today;
                document.getElementById('longest-streak').textContent = progress.longest_streak;
            }

            if (achievements) {
                displayAchievements(achievements.unlocked_achievements);
            }
        }

        function displayAchievements(achievements) {
            const container = document.getElementById('achievements-list');
            if (achievements.length === 0) {
                container.innerHTML = '<p>No achievements unlocked yet. Keep going!</p>';
                return;
            }

            container.innerHTML = achievements.map(achievement => `
                <div class="journal-entry">
                    <h4>${achievement.icon} ${achievement.name}</h4>
                    <p>${achievement.description}</p>
                    <p><strong>XP Earned:</strong> ${achievement.xp_reward}</p>
                    <small>Unlocked: ${new Date(achievement.unlocked_at).toLocaleDateString()}</small>
                </div>
            `).join('');
        }

        async function completeMission(missionId) {
            const response = await apiCall('/gamification/complete-mission', {
                method: 'POST',
                body: JSON.stringify({
                    mission_id: missionId
                })
            });

            if (response) {
                showMessage('Mission completed! +' + response.xp_result.xp_awarded + ' XP', 'success');
                loadDashboard();
                loadGamificationData();
            }
        }

        // Analytics functions
        async function loadAnalytics() {
            const analytics = await apiCall('/analytics/overview?days=30');
            if (analytics) {
                displayAnalytics(analytics);
            }
        }

        // AI Chat functions
        async function loadAIChat() {
            try {
                // Initialize AI therapist chat component
                if (typeof AITherapistChat !== 'undefined') {
                    // Create new instance if it doesn't exist
                    if (!window.aiTherapistChat) {
                        window.aiTherapistChat = new AITherapistChat();
                    }
                    await window.aiTherapistChat.init('ai-chat-container');
                } else {
                    console.error('AI therapist chat component not loaded');
                    document.getElementById('ai-chat-container').innerHTML = '<p>AI Chat component not available</p>';
                }
            } catch (error) {
                console.error('Error loading AI chat:', error);
                document.getElementById('ai-chat-container').innerHTML = '<p>Error loading AI chat: ' + error.message + '</p>';
            }
        }

        // Assignments functions
        async function loadAssignments() {
            try {
                console.log('Loading assignments...');
                console.log('InteractiveAssignments available:', typeof InteractiveAssignments !== 'undefined');
                
                // Initialize interactive assignments component
                if (typeof InteractiveAssignments !== 'undefined') {
                    // Create new instance if it doesn't exist
                    if (!window.interactiveAssignments) {
                        console.log('Creating new InteractiveAssignments instance');
                        window.interactiveAssignments = new InteractiveAssignments();
                    }
                    console.log('Initializing assignments component...');
                    await window.interactiveAssignments.init('assignments-container');
                    console.log('Assignments component initialized successfully');
                } else {
                    console.error('Interactive assignments component not loaded');
                    document.getElementById('assignments-container').innerHTML = '<p>Assignments component not available</p>';
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('assignments-container').innerHTML = '<p>Error loading assignments: ' + error.message + '</p>';
            }
        }

        // Calendar functions
        async function loadCalendar() {
            try {
                // Initialize calendar integration component
                if (typeof CalendarIntegration !== 'undefined') {
                    // Create new instance if it doesn't exist
                    if (!window.calendarIntegration) {
                        window.calendarIntegration = new CalendarIntegration();
                    }
                    await window.calendarIntegration.init('calendar-container');
                } else {
                    console.error('Calendar integration component not loaded');
                    document.getElementById('calendar-container').innerHTML = '<p>Calendar component not available</p>';
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
                document.getElementById('calendar-container').innerHTML = '<p>Error loading calendar: ' + error.message + '</p>';
            }
        }

        function displayAnalytics(analytics) {
            // Display progress chart
            const progressContainer = document.getElementById('progress-chart');
            progressContainer.innerHTML = `
                <h3>Activity Summary</h3>
                <p><strong>Period:</strong> ${analytics.period}</p>
                <p><strong>Therapy Sessions:</strong> ${analytics.data_summary.therapy_sessions}</p>
                <p><strong>Journal Entries:</strong> ${analytics.data_summary.journal_entries}</p>
                <p><strong>Total Activities:</strong> ${analytics.data_summary.total_activities}</p>
            `;

            // Display insights
            const insightsContainer = document.getElementById('insights');
            if (analytics.insights && analytics.insights.length > 0) {
                insightsContainer.innerHTML = analytics.insights.map(insight => `
                    <div class="journal-entry">
                        <h4>${insight.title}</h4>
                        <p>${insight.description}</p>
                    </div>
                `).join('');
            } else {
                insightsContainer.innerHTML = '<p>No insights available yet. Continue using the platform to generate insights!</p>';
            }
        }

        // Utility functions
        function showMessage(message, type) {
            const messagesContainer = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);

            // Remove message after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function showLoginForm() {
            // Hide all sections first
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Create login overlay
            const loginOverlay = document.createElement('div');
            loginOverlay.id = 'login-overlay';
            loginOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            loginOverlay.innerHTML = `
                <div class="card" style="max-width: 400px; width: 90%; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
                    <h2 style="color: #1d1d1f; margin-bottom: 24px; text-align: center;"><i class="fas fa-sign-in-alt" style="color: #007AFF;"></i> Welcome Back</h2>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required placeholder="Enter your password">
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">Sign In</button>
                    </form>
                    <p style="margin-top: 24px; text-align: center; color: #86868b;">
                        <a href="#" onclick="showRegisterForm()" style="color: #007AFF; text-decoration: none;">Don't have an account? Register</a>
                    </p>
                </div>
            `;
            
            document.body.appendChild(loginOverlay);
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showRegisterForm() {
            // Remove existing login overlay if present
            const existingOverlay = document.getElementById('login-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            // Create register overlay
            const registerOverlay = document.createElement('div');
            registerOverlay.id = 'register-overlay';
            registerOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            registerOverlay.innerHTML = `
                <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
                    <h2 style="color: #1d1d1f; margin-bottom: 24px; text-align: center;"><i class="fas fa-user-plus" style="color: #007AFF;"></i> Create Your Account</h2>
                    <form id="register-form">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username" required placeholder="Choose a username">
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" required placeholder="Create a password">
                        </div>
                        <div class="form-group">
                            <label for="first_name">First Name *</label>
                            <input type="text" id="first_name" required placeholder="Enter your first name">
                        </div>
                        <div class="form-group">
                            <label for="last_name">Last Name</label>
                            <input type="text" id="last_name" placeholder="Enter your last name">
                        </div>
                        <div class="form-group">
                            <label for="age">Age</label>
                            <input type="number" id="age" min="13" max="120" placeholder="Enter your age">
                        </div>
                        <div class="form-group">
                            <label for="education_level">Education Level</label>
                            <select id="education_level" style="width: 100%; padding: 16px; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 12px; font-size: 1rem; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px);">
                                <option value="">Select education level</option>
                                <option value="high_school">High School</option>
                                <option value="some_college">Some College</option>
                                <option value="associates">Associate's Degree</option>
                                <option value="bachelors">Bachelor's Degree</option>
                                <option value="masters">Master's Degree</option>
                                <option value="doctorate">Doctorate</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">Create Account</button>
                    </form>
                    <p style="margin-top: 24px; text-align: center; color: #86868b;">
                        <a href="#" onclick="showLoginForm()" style="color: #007AFF; text-decoration: none;">Already have an account? Sign In</a>
                    </p>
                </div>
            `;
            
            document.body.appendChild(registerOverlay);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const formData = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    if (data.refresh_token) {
                        localStorage.setItem('refresh_token', data.refresh_token);
                    }
                    if (data.user) {
                        localStorage.setItem('user_data', JSON.stringify(data.user));
                    }
                    
                    // Remove login overlay
                    const loginOverlay = document.getElementById('login-overlay');
                    if (loginOverlay) {
                        loginOverlay.remove();
                    }
                    
                    showMessage('Login successful! Welcome to MindFlora!', 'success');
                    
                    // Update user profile immediately
                    updateUserProfile();
                    
                    // Show dashboard
                    loadDashboard();
                } else {
                    showMessage('Login failed: ' + data.detail, 'error');
                }
            } catch (error) {
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
                education_level: document.getElementById('education_level').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    showMessage('Registration successful! Welcome to MindFlora!', 'success');
                    
                    // Update user profile immediately
                    updateUserProfile();
                    
                    // Show dashboard
                    loadDashboard();
                } else {
                    showMessage('Registration failed: ' + data.detail, 'error');
                }
            } catch (error) {
                showMessage('Registration failed: ' + error.message, 'error');
            }
        }

        function logout() {
            // Clear all stored data
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            
            // Show logout message
            showMessage('Successfully logged out. Thank you for using MindFlora!', 'success');
            
            // Redirect to login after a short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        // Update user profile display
        async function updateUserProfile() {
            const token = localStorage.getItem('access_token');
            const userProfile = document.getElementById('user-profile');
            const guestIndicator = document.getElementById('guest-indicator');
            
            console.log('updateUserProfile called, token:', token ? 'exists' : 'none');
            console.log('userProfile element:', userProfile);
            console.log('guestIndicator element:', guestIndicator);
            
            if (token) {
                console.log('User is logged in, hiding guest indicator');
                // Hide guest indicator
                if (guestIndicator) {
                    guestIndicator.style.display = 'none';
                }
                
                // Show user profile immediately
                if (userProfile) {
                    userProfile.style.display = 'block';
                }
                
                try {
                    console.log('Trying to get user info from API...');
                    // Get user info from API
                    const response = await apiCall('/auth/me');
                    console.log('API response:', response);
                    
                    if (response && (response.username || response.email)) {
                        const userInfo = document.getElementById('user-info');
                        console.log('userInfo element:', userInfo);
                        
                        if (userInfo) {
                            console.log('Setting username from API response');
                            // Show actual username - prioritize first_name + last_name, then username, then email
                            let displayName = 'User';
                            let welcomeName = 'User';
                            
                            if (response.first_name && response.last_name) {
                                displayName = `${response.first_name} ${response.last_name}`;
                                welcomeName = response.first_name; // Use first name only for welcome
                            } else if (response.first_name) {
                                displayName = response.first_name;
                                welcomeName = response.first_name;
                            } else if (response.username) {
                                displayName = response.username;
                                welcomeName = response.username;
                            } else if (response.email) {
                                displayName = response.email.split('@')[0]; // Use email prefix as username
                                welcomeName = response.email.split('@')[0];
                            }
                            userInfo.textContent = displayName;
                            
                            // Update welcome message with first name only
                            const welcomeMessage = document.getElementById('welcome-message');
                            if (welcomeMessage) {
                                welcomeMessage.textContent = `Welcome, ${welcomeName}!`;
                            }
                            
                            // Store display name for use throughout the app
                            localStorage.setItem('user_display_name', displayName);
                            
                            console.log('Set username to:', displayName);
                        } else {
                            console.log('Missing userInfo element');
                        }
                    } else {
                        console.log('No user data in API response');
                    }
                } catch (error) {
                    console.log('Could not get user info from API, trying token decode:', error);
                    try {
                        // Fallback: decode JWT token
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        console.log('Token payload:', payload);
                        const userInfo = document.getElementById('user-info');
                        
                        if (userInfo) {
                            // Try to get username from token payload - same logic as API response
                            let displayName = 'User';
                            let welcomeName = 'User';
                            
                            if (payload.first_name && payload.last_name) {
                                displayName = `${payload.first_name} ${payload.last_name}`;
                                welcomeName = payload.first_name; // Use first name only for welcome
                            } else if (payload.first_name) {
                                displayName = payload.first_name;
                                welcomeName = payload.first_name;
                            } else if (payload.username) {
                                displayName = payload.username;
                                welcomeName = payload.username;
                            } else if (payload.email) {
                                displayName = payload.email.split('@')[0]; // Use email prefix as username
                                welcomeName = payload.email.split('@')[0];
                            }
                            userInfo.textContent = displayName;
                            
                            // Update welcome message with first name only
                            const welcomeMessage = document.getElementById('welcome-message');
                            if (welcomeMessage) {
                                welcomeMessage.textContent = `Welcome, ${welcomeName}!`;
                            }
                            
                            // Store display name for use throughout the app
                            localStorage.setItem('user_display_name', displayName);
                            
                            console.log('Set username from token to:', displayName);
                        }
                    } catch (decodeError) {
                        console.log('Could not decode user info from token:', decodeError);
                        // Final fallback: show generic user info
                        const userInfo = document.getElementById('user-info');
                        if (userInfo) {
                            userInfo.textContent = 'User';
                            console.log('Set fallback username');
                        }
                        
                        // Update welcome message
                        const welcomeMessage = document.getElementById('welcome-message');
                        if (welcomeMessage) {
                            welcomeMessage.textContent = 'Welcome back!';
                        }
                    }
                }
            } else {
                console.log('User is not logged in, showing guest indicator');
                // Show guest indicator and hide user profile
                if (guestIndicator) {
                    guestIndicator.style.display = 'flex';
                }
                if (userProfile) {
                    userProfile.style.display = 'none';
                }
            }
        }
    </script>
    
    <!-- New Component Scripts -->
    <script src="components/progress-dashboard.js"></script>
    <script src="components/mood-tracker.js"></script>
    <script src="components/achievement-gallery.js"></script>
    <script src="components/ai-therapist-chat.js"></script>
    <script src="components/interactive-assignments.js"></script>
    <script src="components/calendar-integration.js"></script>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Component Styles -->
    <link rel="stylesheet" href="styles/components.css">

    <!-- Assignment Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Assignment Details</h3>
                <span class="close" onclick="interactiveAssignments.hideAssignmentModal()">&times;</span>
            </div>
            <div id="modal-content">
                <!-- Assignment content will be loaded here -->
            </div>
        </div>
    </div>
</body>
</html> 